import axiosInstance from '../config/axios';
import { ApiResponse, PagedResponse } from '../api-helpers';

// Depolar arasÄ± sevk yanÄ±t tipi
export interface WarehouseTransferResponse {
  transferNumber: string;
  operationDate: string;
  operationTime: string;
  sourceWarehouseCode: string;
  sourceWarehouseName: string;
  targetWarehouseCode: string;
  targetWarehouseName: string;
  totalQty: number;
  description: string;
  isCompleted: boolean;
  isLocked: boolean;
  lockedByUser?: string;
  lockDate?: string;
  items: WarehouseTransferItemResponse[];
}

// Depolar arasÄ± sevk satÄ±r yanÄ±t tipi
export interface WarehouseTransferItemResponse {
  itemCode: string;
  itemName: string;
  colorCode?: string;
  colorName?: string;
  itemDim1Code?: string;
  itemDim1Name?: string;
  quantity: number;
  unitCode?: string;
  barcode?: string;
  lineDescription?: string;
}

// Depolar arasÄ± sevk istek tipi
export interface WarehouseTransferRequest {
  sourceWarehouseCode: string;
  targetWarehouseCode: string;
  description?: string;
  operationDate?: string; // Ä°ÅŸlem tarihi
  shipmentMethodCode: string; // Sevkiyat yÃ¶ntemi kodu (zorunlu)
  items: WarehouseTransferItemRequest[];
}

// Depolar arasÄ± sevk satÄ±r istek tipi
export interface WarehouseTransferItemRequest {
  itemCode: string;
  colorCode?: string;
  itemDim1Code?: string;
  quantity: number;
  unitCode: string;
  lineDescription?: string;
  barcode?: string; // Barkod (API tarafÄ±ndan zorunlu)
}

// Depolar arasÄ± sevk filtreleme parametreleri
export interface WarehouseTransferFilterParams {
  sourceWarehouseCode?: string;
  targetWarehouseCode?: string;
  startDate?: Date;
  endDate?: Date;
}

// Depo yanÄ±t tipi
export interface WarehouseResponse {
  warehouseCode: string;
  warehouseDescription: string; // API'den gelen gerÃ§ek alan adÄ±
  companyCode: string;
  officeCode: string;
  officeDescription: string;
  warehouseOwnerCode: string;
  warehouseOwnerDescription: string;
  warehouseTypeCode: string;
  warehouseTypeDescription: string;
  isBlocked: boolean;
  // DiÄŸer alanlar
}

const warehouseTransferApi = {
  // Depolar arasÄ± sevk listesini getiren fonksiyon
  getWarehouseTransfers: async (params?: WarehouseTransferFilterParams): Promise<WarehouseTransferResponse[]> => {
    try {
      const queryParams = new URLSearchParams();
      
      if (params?.sourceWarehouseCode) {
        queryParams.append('sourceWarehouseCode', params.sourceWarehouseCode);
      }
      
      if (params?.targetWarehouseCode) {
        queryParams.append('targetWarehouseCode', params.targetWarehouseCode);
      }
      
      if (params?.startDate) {
        queryParams.append('startDate', params.startDate.toISOString().split('T')[0]);
      }
      
      if (params?.endDate) {
        queryParams.append('endDate', params.endDate.toISOString().split('T')[0]);
      }
      
      const url = `/api/WarehouseTransfer${queryParams.toString() ? `?${queryParams.toString()}` : ''}`;
      console.log('ğŸ“¡ API: Calling getWarehouseTransfers', { url });
      const response = await axiosInstance.get<ApiResponse<any[]>>(url);
      console.log('ğŸ“¡ API: getWarehouseTransfers response', { status: response.status, data: response.data });
      
      if (response.data.success && response.data.data) {
        // Gelen veriyi frontend modeline dÃ¶nÃ¼ÅŸtÃ¼r ve eksik alanlarÄ± varsayÄ±lan deÄŸerlerle doldur
        return response.data.data.map((item: any) => ({
          transferNumber: item.transferNumber || '',
          operationDate: item.operationDate || new Date().toISOString(),
          operationTime: item.operationTime || '',
          sourceWarehouseCode: item.sourceWarehouseCode || '',
          sourceWarehouseName: item.sourceWarehouseName || 'Bilinmeyen Depo',
          targetWarehouseCode: item.targetWarehouseCode || '',
          targetWarehouseName: item.targetWarehouseName || 'Bilinmeyen Depo',
          totalQty: item.totalQty || 0,
          description: item.description || '',
          isCompleted: item.isCompleted || false,
          isLocked: item.isLocked || false,
          lockedByUser: item.lockedByUser || '',
          lockDate: item.lockDate || '',
          items: item.items || []
        }));
      }
      
      return [];
    } catch (error: any) {
      console.error('ğŸ“¡ API Error: getWarehouseTransfers failed', { 
        message: error.message, 
        status: error.response?.status,
        data: error.response?.data
      });
      return [];
    }
  },
  
  // Belirli bir depolar arasÄ± sevk kaydÄ±nÄ± getiren fonksiyon
  getWarehouseTransferByNumber: async (transferNumber: string): Promise<WarehouseTransferResponse | null> => {
    try {
      const response = await axiosInstance.get<ApiResponse<WarehouseTransferResponse>>(`/api/WarehouseTransfer/${transferNumber}`);
      
      if (response.data.success && response.data.data) {
        return response.data.data;
      } else {
        console.warn(`API: WarehouseTransfer/${transferNumber} endpoint returned success=false or no data`, response.data);
        return null;
      }
    } catch (error) {
      console.error(`API: Error fetching warehouse transfer ${transferNumber}`, error);
      return null;
    }
  },
  
  // Yeni bir depolar arasÄ± sevk kaydÄ± oluÅŸturan fonksiyon
  createWarehouseTransfer: async (request: WarehouseTransferRequest): Promise<string | null> => {
    try {
      // Ä°stek verilerini detaylÄ± gÃ¶rÃ¼ntÃ¼le
      console.log('API isteÄŸi detaylarÄ±:', JSON.stringify(request, null, 2));
      
      // Ã–nemli alanlarÄ± kontrol et
      console.log('Kaynak depo:', request.sourceWarehouseCode);
      console.log('Hedef depo:', request.targetWarehouseCode);
      console.log('Ä°ÅŸlem tarihi:', request.operationDate);
      console.log('ÃœrÃ¼n sayÄ±sÄ±:', request.items.length);
      
      // ÃœrÃ¼n detaylarÄ±nÄ± kontrol et
      request.items.forEach((item, index) => {
        console.log(`ÃœrÃ¼n ${index + 1}:`, {
          itemCode: item.itemCode,
          colorCode: item.colorCode,
          itemDim1Code: item.itemDim1Code,
          quantity: item.quantity,
          unitCode: item.unitCode
        });
      });
      
      const response = await axiosInstance.post<ApiResponse<string>>('/api/WarehouseTransfer', request);
      
      if (response.data.success && response.data.data) {
        return response.data.data; // OluÅŸturulan sevk numarasÄ±
      } else {
        console.warn('API: WarehouseTransfer create endpoint returned success=false or no data', response.data);
        return null;
      }
    } catch (error: any) {
      console.error('API: Error creating warehouse transfer', error);
      
      // Hata detaylarÄ±nÄ± gÃ¶rÃ¼ntÃ¼le
      if (error.response) {
        console.error('Hata detaylarÄ±:', {
          status: error.response.status,
          statusText: error.response.statusText,
          data: error.response.data
        });
        
        // Validasyon hatalarÄ±nÄ± gÃ¶rÃ¼ntÃ¼le
        if (error.response.data.validationErrors) {
          console.log('Validasyon hatalarÄ±:', error.response.data.validationErrors);
          
          // Her bir validasyon hatasÄ±nÄ± detaylÄ± gÃ¶ster
          error.response.data.validationErrors.forEach((validationError: any, index: number) => {
            console.log(`Validasyon hatasÄ± ${index + 1}:`, {
              property: validationError.property,
              message: validationError.message,
              value: validationError.value
            });
          });
        }
        
        // API mesajÄ±nÄ± gÃ¶rÃ¼ntÃ¼le
        if (error.response.data.message) {
          console.log('API mesajÄ±:', error.response.data.message);
        }
        
        // TÃ¼m yanÄ±tÄ± gÃ¶rÃ¼ntÃ¼le
        console.log('API yanÄ±tÄ± (tÃ¼m):', error.response.data);
      }
      
      return null;
    }
  },
  
  // Depolar arasÄ± sevk kaydÄ±nÄ± onaylayan fonksiyon
  approveWarehouseTransfer: async (transferNumber: string): Promise<boolean> => {
    try {
      const response = await axiosInstance.post<ApiResponse<boolean>>(`/api/WarehouseTransfer/${transferNumber}/approve`);
      
      if (response.data.success && response.data.data) {
        return true;
      } else {
        console.warn(`API: WarehouseTransfer/${transferNumber}/approve endpoint returned success=false or no data`, response.data);
        return false;
      }
    } catch (error) {
      console.error(`API: Error approving warehouse transfer ${transferNumber}`, error);
      return false;
    }
  },
  
  // Depolar arasÄ± sevk kaydÄ±nÄ± iptal eden fonksiyon
  cancelWarehouseTransfer: async (transferNumber: string): Promise<boolean> => {
    try {
      const response = await axiosInstance.post<ApiResponse<boolean>>(`/api/WarehouseTransfer/${transferNumber}/cancel`);
      
      if (response.data.success && response.data.data) {
        return true;
      } else {
        console.warn(`API: WarehouseTransfer/${transferNumber}/cancel endpoint returned success=false or no data`, response.data);
        return false;
      }
    } catch (error) {
      console.error(`API: Error canceling warehouse transfer ${transferNumber}`, error);
      return false;
    }
  },
  
  // Depolar arasÄ± sevk kaydÄ±nÄ± kilitleyen fonksiyon
  lockWarehouseTransfer: async (transferNumber: string): Promise<boolean> => {
    try {
      const response = await axiosInstance.post<ApiResponse<boolean>>(`/api/WarehouseTransfer/${transferNumber}/lock`);
      
      if (response.data.success && response.data.data) {
        return true;
      } else {
        console.warn(`API: WarehouseTransfer/${transferNumber}/lock endpoint returned success=false or no data`, response.data);
        return false;
      }
    } catch (error) {
      console.error(`API: Error locking warehouse transfer ${transferNumber}`, error);
      return false;
    }
  },
  
  // Depolar arasÄ± sevk kaydÄ±nÄ±n kilidini aÃ§an fonksiyon
  unlockWarehouseTransfer: async (transferNumber: string): Promise<boolean> => {
    try {
      const response = await axiosInstance.post<ApiResponse<boolean>>(`/api/WarehouseTransfer/${transferNumber}/unlock`);
      
      if (response.data.success && response.data.data) {
        return true;
      } else {
        console.warn(`API: WarehouseTransfer/${transferNumber}/unlock endpoint returned success=false or no data`, response.data);
        return false;
      }
    } catch (error) {
      console.error(`API: Error unlocking warehouse transfer ${transferNumber}`, error);
      return false;
    }
  },
  
  // Belirli bir sevk kaydÄ±nÄ±n satÄ±r detaylarÄ±nÄ± getiren fonksiyon
  getWarehouseTransferItems: async (transferNumber: string): Promise<WarehouseTransferItemResponse[]> => {
    try {
      console.log('ğŸ“¡ API: Calling getWarehouseTransferItems', { transferNumber });
      const response = await axiosInstance.get<ApiResponse<WarehouseTransferItemResponse[]>>(`/api/WarehouseTransfer/${transferNumber}/items`);
      console.log('ğŸ“¡ API: getWarehouseTransferItems response', { status: response.status, data: response.data });
      
      if (response.data.success && response.data.data) {
        // Gelen veriyi frontend modeline dÃ¶nÃ¼ÅŸtÃ¼r ve eksik alanlarÄ± varsayÄ±lan deÄŸerlerle doldur
        return response.data.data.map((item: any) => ({
          itemCode: item.itemCode || '',
          itemName: item.itemName || 'Bilinmeyen ÃœrÃ¼n',
          colorCode: item.colorCode || '',
          colorName: item.colorName || '',
          itemDim1Code: item.itemDim1Code || '',
          itemDim1Name: item.itemDim1Name || '',
          quantity: item.quantity || 0,
          unitCode: item.unitCode || '',
          barcode: item.barcode || '',
          lineDescription: item.lineDescription || ''
        }));
      }
      
      return [];
    } catch (error: any) {
      console.error(`ğŸ“¡ API Error: getWarehouseTransferItems failed for ${transferNumber}`, { 
        message: error.message, 
        status: error.response?.status,
        data: error.response?.data
      });
      return [];
    }
  },
  
  // DepolarÄ± getiren fonksiyon
  getWarehouses: async (): Promise<WarehouseResponse[]> => {
    try {
      console.log('ğŸ“¡ API: Calling getWarehouses');
      const response = await axiosInstance.get<ApiResponse<WarehouseResponse[]>>('/api/WarehouseTransfer/warehouses');
      console.log('ğŸ“¡ API: getWarehouses response', { status: response.status, data: response.data });
      
      if (response.data.success && response.data.data) {
        // API'den gelen depo verilerini detaylÄ± kontrol et
        console.log('ğŸ“¦ Depo verileri:', JSON.stringify(response.data.data, null, 2));
        
        // Her bir depo iÃ§in kontrol yap
        const warehouses = response.data.data;
        warehouses.forEach((warehouse, index) => {
          console.log(`Depo ${index + 1}:`, {
            warehouseCode: warehouse.warehouseCode,
            warehouseDescription: warehouse.warehouseDescription,
            hasName: !!warehouse.warehouseDescription
          });
        });
        
        return response.data.data;
      } else {
        console.warn('API: WarehouseTransfer/warehouses endpoint returned success=false or no data', response.data);
        return [];
      }
    } catch (error: any) {
      console.error('API: Error fetching warehouses', { 
        message: error.message, 
        status: error.response?.status,
        data: error.response?.data,
        config: error.config
      });
      return [];
    }
  }
};

export default warehouseTransferApi;
